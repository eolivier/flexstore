name: flex-bot

on:
  issues:
    types: [opened, edited]

jobs:
  create_pr:
    runs-on: ubuntu-latest

    # Run only when the issue body contains the command
    if: contains(github.event.issue.body || '', '@flex-bot create-pr')

    permissions:
      contents: write
      pull-requests: write

    services:
      ollama:
        image: ollama/ollama:latest
        ports:
          - 11434:11434

    steps:
      - name: Debug issue body
        run: |
          echo "=== EVENT NAME ==="
          echo "${{ github.event_name }}"
          echo "=== ISSUE NUMBER ==="
          echo "${{ github.event.issue.number }}"
          echo "=== ISSUE BODY ==="
          echo ">>${{ github.event.issue.body }}<<"

      - name: Extract prompt from issue body
        id: extract
        run: |
          body="${{ github.event.issue.body }}"
          marker='@flex-bot create-pr'

          echo "=== RAW BODY ==="
          printf '%s\n' "$body"

          # Everything after the marker
          prompt="${body#*$marker}"

          # Trim leading spaces/newlines
          prompt="$(printf '%s\n' "$prompt" | sed 's/^[[:space:]]*//')"

          # Remove leading ":" and spaces
          prompt="$(printf '%s\n' "$prompt" | sed 's/^[: ]*//')"

          # Trim trailing spaces/newlines
          prompt="$(printf '%s\n' "$prompt" | sed 's/[[:space:]]*$//')"

          echo "=== EXTRACTED PROMPT ==="
          printf '>>%s<<\n' "$prompt"

          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$prompt" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Check prompt is not empty
        run: |
          if [ -z "${{ steps.extract.outputs.prompt }}" ]; then
            echo "Prompt is empty after extraction. Nothing to do."
            exit 1
          fi

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Wait for Ollama and pull model
        run: |
          echo "Waiting for Ollama to be ready..."
          for i in {1..30}; do
            if curl -sSf http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "Ollama is up."
              break
            fi
            echo "Ollama not ready yet, retrying..."
            sleep 2
          done

          echo "Pulling model llama3.1..."
          curl -sS -X POST http://localhost:11434/api/pull \
            -d '{"model":"llama3.1"}' || echo "Model pull finished (or already present)."

      - name: Generate content with Ollama
        id: ollama
        env:
          PROMPT: ${{ steps.extract.outputs.prompt }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          node - << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const prompt = process.env.PROMPT || '';
          const issueNumber = process.env.ISSUE_NUMBER;

          if (!prompt.trim()) {
            console.error('Prompt is empty. Nothing to do.');
            process.exit(1);
          }

          console.info('Issue number:', issueNumber);
          console.info('Prompt for Ollama:', prompt);

          async function main() {
            const res = await fetch('http://localhost:11434/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                model: 'llama3.1',
                prompt,
                stream: false
              }),
            });

            if (!res.ok) {
              console.error('Ollama API error:', res.status);
              console.error(await res.text());
              process.exit(1);
            }

            const data = await res.json();
            const content = data.response || '# flex-bot\n\nNo content generated.';

            const dir = path.join('docs', 'flex-bot');
            fs.mkdirSync(dir, { recursive: true });

            const filePath = path.join(dir, `issue-${issueNumber}.md`);
            fs.writeFileSync(filePath, content, 'utf8');

            console.info('Written file:', filePath);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Debug git status
        run: |
          echo "=== GIT STATUS ==="
          git status
          echo "=== GIT DIFF ==="
          git diff

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: flex-bot auto PR for #${{ github.event.issue.number }}"
          title: "flex-bot: auto PR for issue #${{ github.event.issue.number }}"
          body: |
            This pull request was created automatically by **flex-bot**.

            Source issue: #${{ github.event.issue.number }}
          branch: "flex-bot/issue-${{ github.event.issue.number }}-${{ github.run_id }}"
          labels: |
            flex-bot
            automated pr
