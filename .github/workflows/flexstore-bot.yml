name: flex-bot

on:
  issue_comment:
    types: [created]

jobs:
  respond:
    # Trigger on ANY issue comment (issues + PRs) containing @flex-bot
    if: contains(github.event.comment.body, '@flex-bot')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Extract user prompt
        id: extract
        run: |
          body="${{ github.event.comment.body }}"
          prompt="${body#*@flex-bot}"
          prompt="$(echo "$prompt" | sed 's/^[[:space:]]*//')"
          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          echo "$prompt" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          node - << 'EOF'
          const apiKey = process.env.OPENAI_API_KEY;
          const prompt = process.env.PROMPT || '';

          if (!apiKey) {
            console.error('Missing OPENAI_API_KEY');
            process.exit(1);
          }

          if (!prompt.trim()) {
            console.error('Prompt is empty. Nothing to do.');
            process.exit(0);
          }

          async function callOpenAI() {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4.1-mini',
                messages: [
                  {
                    role: 'system',
                    content: 'You are a technical reviewer for the flexstore project. Respond concisely and helpfully.'
                  },
                  {
                    role: 'user',
                    content: prompt
                  }
                ]
              })
            });

            if (!response.ok) {
              console.error('OpenAI API error:', response.status);
              console.error(await response.text());
              process.exit(1);
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'I could not generate a response.';

            const fs = require('fs');
            fs.writeFileSync('reply.txt', reply, 'utf8');
          }

          callOpenAI().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Post reply
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reply = fs.readFileSync('reply.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reply
            });
