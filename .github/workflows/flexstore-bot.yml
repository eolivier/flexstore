name: flex-bot

on:
  issues:
    types: [opened, edited]

jobs:
  create_pr:
    runs-on: ubuntu-latest

    # Run only when the issue body contains "@flex-bot create-pr"
    if: contains(github.event.issue.body || '', '@flex-bot create-pr')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Debug issue body
        run: |
          echo "=== EVENT NAME ==="
          echo "${{ github.event_name }}"
          echo "=== ISSUE NUMBER ==="
          echo "${{ github.event.issue.number }}"
          echo "=== ISSUE BODY ==="
          echo ">>${{ github.event.issue.body }}<<"

      - name: Extract prompt from issue body
        id: extract
        run: |
          body="${{ github.event.issue.body }}"
          marker='@flex-bot create-pr'

          echo "=== RAW BODY ==="
          printf '%s\n' "$body"

          # Everything after the marker
          prompt="${body#*$marker}"

          # Trim leading spaces/newlines
          prompt="$(printf '%s\n' "$prompt" | sed 's/^[[:space:]]*//')"

          # Remove leading ":" and spaces
          prompt="$(printf '%s\n' "$prompt" | sed 's/^[: ]*//')"

          # Trim trailing spaces/newlines
          prompt="$(printf '%s\n' "$prompt" | sed 's/[[:space:]]*$//')"

          echo "=== EXTRACTED PROMPT ==="
          printf '>>%s<<\n' "$prompt"

          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$prompt" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Check prompt is not empty
        run: |
          if [ -z "${{ steps.extract.outputs.prompt }}" ]; then
            echo "Prompt is empty after extraction. Nothing to do."
            exit 1
          fi

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Call OpenAI to generate content
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ steps.extract.outputs.prompt }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          node - << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const apiKey = process.env.OPENAI_API_KEY;
          const prompt = process.env.PROMPT || '';
          const issueNumber = process.env.ISSUE_NUMBER;

          if (!apiKey) {
            console.error('Missing OPENAI_API_KEY');
            process.exit(1);
          }

          if (!prompt.trim()) {
            console.error('Prompt is empty. Nothing to do.');
            process.exit(1);
          }

          console.info('Issue number:', issueNumber);
          console.info('Prompt for OpenAI:', prompt);

          async function main() {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4.1-mini',
                messages: [
                  {
                    role: 'system',
                    content: [
                      'You are an assistant generating a small, reviewable change for the flexstore project.',
                      '- Prefer Markdown documentation or small code snippets.',
                      '- Keep the change focused on the user request.',
                      '- If you write code, explain briefly what it does in comments.',
                    ].join('\n')
                  },
                  {
                    role: 'user',
                    content: `Create content for a pull request based on the following request from issue #${issueNumber}: ${prompt}`
                  }
                ]
              })
            });

            if (!response.ok) {
              console.error('OpenAI API error:', response.status);
              console.error(await response.text());
              process.exit(1);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || '# flex-bot\n\nNo content generated.';

            console.info('Received content length:', content.length);

            const dir = path.join('docs', 'flex-bot');
            fs.mkdirSync(dir, { recursive: true });

            const filePath = path.join(dir, `issue-${issueNumber}.md`);
            fs.writeFileSync(filePath, content, 'utf8');

            console.info('Written file:', filePath);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Debug git status
        run: |
          echo "=== GIT STATUS ==="
          git status
          echo "=== GIT DIFF ==="
          git diff

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: flex-bot auto PR for #${{ github.event.issue.number }}"
          title: "flex-bot: auto PR for issue #${{ github.event.issue.number }}"
          body: |
            This pull request was created automatically by **flex-bot**.

            Source issue: #${{ github.event.issue.number }}
          branch: "flex-bot/issue-${{ github.event.issue.number }}-${{ github.run_id }}"
          labels: |
            flex-bot
            automated pr
