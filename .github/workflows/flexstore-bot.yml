name: flex-bot

on:
  issue_comment:
    types: [ created ]
  issues:
    types: [ opened, edited ]

jobs:
  reply:
    # Simple reply in Issues/PRs when using @flex-bot
    if: contains(github.event.comment.body, '@flex-bot') && !contains(github.event.comment.body, '@flex-bot create-pr')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Debug values
        run: |
          echo "==== EVENT NAME ===="
          echo "${{ github.event_name }}"
          echo "==== RAW COMMENT BODY ===="
          echo "${{ github.event.comment.body }}"
          echo "==== RAW ISSUE BODY ===="
          echo "${{ github.event.issue.body }}"

      - name: Extract PR prompt
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            body="${{ github.event.comment.body }}"
          else
            body="${{ github.event.issue.body }}"
          fi
          
          console.error("=== RAW BODY START ===")
          console.error("body : ", $body)
          console.error("=== RAW BODY END ===")

          # Keep text after "@flex-bot create-pr"
          prompt="${body#*@flex-bot create-pr}"
          prompt="$(echo "$prompt" | sed 's/^[[:space:]]*//')"

          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          echo "$prompt" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          node - << 'EOF'
          const apiKey = process.env.OPENAI_API_KEY;
          const prompt = process.env.PROMPT || '';

          if (!apiKey) {
            console.error('Missing OPENAI_API_KEY');
            process.exit(1);
          }

          if (!prompt.trim()) {
            console.error('Prompt is empty. Nothing to do.');
            process.exit(0);
          }

          async function callOpenAI() {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4.1-mini',
                messages: [
                  {
                    role: 'system',
                    content: 'You are a technical reviewer for the flexstore project. Respond concisely and helpfully.'
                  },
                  {
                    role: 'user',
                    content: prompt
                  }
                ]
              })
            });

            if (!response.ok) {
              console.error('OpenAI API error:', response.status);
              console.error(await response.text());
              process.exit(1);
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'I could not generate a response.';

            const fs = require('fs');
            fs.writeFileSync('reply.txt', reply, 'utf8');
          }

          callOpenAI().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Post reply
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reply = fs.readFileSync('reply.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reply
            });

  create_pr:
    # Create a PR when comment contains "@flex-bot create-pr"
    if: >
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@flex-bot create-pr')) ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.body, '@flex-bot create-pr'))
    runs-on: ubuntu-latest

    permissions:
      contents: write        # needed to commit changes
      pull-requests: write   # needed to open PR

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Extract PR prompt
        id: extract
        run: |
          body="${{ github.event.comment.body }}"
          # Keep text after "@flex-bot create-pr"
          prompt="${body#*@flex-bot create-pr}"
          prompt="$(echo "$prompt" | sed 's/^[[:space:]]*//')"
          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          echo "$prompt" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Call OpenAI to generate content
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ steps.extract.outputs.prompt }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          node - << 'EOF'
          const apiKey = process.env.OPENAI_API_KEY;
          const prompt = process.env.PROMPT || '';
          const issueNumber = process.env.ISSUE_NUMBER;

          if (!apiKey) {
            console.error('Missing OPENAI_API_KEY');
            process.exit(1);
          }

          if (!prompt.trim()) {
            console.error('Prompt is empty. Nothing to do.');
            process.exit(0);
          }

          async function callOpenAI() {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4.1-mini',
                messages: [
                  {
                    role: 'system',
                    content: 'You are an assistant generating Markdown documentation or code snippets for the flexstore project. Write clean, well-structured content.'
                  },
                  {
                    role: 'user',
                    content: `Create content for a pull request based on this request (from issue or PR #${issueNumber}): ${prompt}`
                  }
                ]
              })
            });

            if (!response.ok) {
              console.error('OpenAI API error:', response.status);
              console.error(await response.text());
              process.exit(1);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || '# flex-bot\n\nNo content generated.';

            const fs = require('fs');
            const path = require('path');

            const dir = path.join('docs', 'flex-bot');
            fs.mkdirSync(dir, { recursive: true });

            const filePath = path.join(dir, `pr-from-issue-${issueNumber}.md`);
            fs.writeFileSync(filePath, content, 'utf8');

            console.log('Generated file:', filePath);
          }

          callOpenAI().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: add flex-bot generated content"
          title: "flex-bot: generated content for issue #${{ github.event.issue.number }}"
          body: |
            This pull request was created automatically by **flex-bot**.

            Source: comment on issue/PR #${{ github.event.issue.number }}.
          branch: "flex-bot/issue-${{ github.event.issue.number }}"
          labels: |
            automated pr
            flex-bot
